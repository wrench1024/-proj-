from fastapi import APIRouter, Body
from openai import AsyncOpenAI
import asyncio
import json
from app.core.config import get_logger
import re
from typing import Optional

client = AsyncOpenAI(
    api_key="sk-762b0529add947b081778614c7fe1cda",
    base_url="https://dashscope.aliyuncs.com/compatible-mode/v1"
)

router = APIRouter()
logger = get_logger(__name__)

@router.post("/llm_extract_key_elements/")
async def llm_extract_key_elements(
    kbSearchConfig: list = Body([], description="知识库检索词列表，支持多个关键词"),
    reviewItemPrompt: str = Body("", description="审查项要求"),
    relArray: str = Body("", description="包含完整知识库结构的上下文文本"),
    
):
    
    json_format = {
    "usedKnowledgeBaseContent": "对在审查当前指标过程中用到的【参考知识库内容】，需根据【知识库查询词列表】和【审查项要求】提取出相关完整的上下文段落内容，无关内容全部去除，严格保留原文段落的**所有格式符号（包括#、标点、缩进、换行符）**，不做任何内容修改。当引用标准文件中的某条规定时，需将该条规定完整输出，而不仅仅是当前审查项涉及的情况。需从relArray的content字段中直接提取原始段落，同时包含fileName、fileId、filePath、score字段，以列表形式严格保留原文格式。若返回结果中出现重复段落（content存在重叠且整体几乎一致），仅取这些段落内容的交集作为结果保留。若涉及表格数据，无论是否仅使用到表格部分数据，都需提取包含表格标题且从 <html> 标签开始到 </html> 标签结束的完整原始表格内容段落，无需去除其中无关的表格数据内容，完整提取整个表格数据。"
    }
    """
    json_format = {
    "usedKnowledgeBaseContent": "对在审查当前指标过程中用到的【参考知识库内容】，需根据【知识库查询词列表】和【审查项要求】提取出相关完整的上下文段落内容，无关内容全部去除，严格保留原文段落文本内容和**所有符号（包括\n、#、标点符号等）**，不做任何格式修改。当引用标准文件中的某条规定时，需将该条规定完整输出，而不仅仅是当前审查项涉及的情况。需从relArray的content字段中直接提取原始段落，同时包含fileName、fileId、filePath、score字段，以列表形式严格保留原文格式"
    }
    
    json_format = {
    "usedKnowledgeBaseContent": "对在审查当前指标过程中用到的【参考知识库内容】，需根据【知识库查询词列表】和【审查项要求】提取出相关完整的上下文段落内容，无关内容全部去除，严格保留原文段落的**所有格式符号（包括#、标点、缩进、换行符）**，不做任何内容修改。当引用标准文件中的某条规定时，需将该条规定完整输出，而不仅仅是当前审查项涉及的情况。需从relArray的content字段中直接提取原始段落，同时包含fileName、fileId、filePath、score字段，以列表形式严格保留原文格式。若返回结果中出现重复段落（content存在重叠且整体几乎一致），仅取这些段落内容的交集作为结果保留。若涉及表格数据，无论是否仅使用到表格部分数据，都需提取包含表格标题且从 <html> 标签开始到 </html> 标签结束的完整原始表格内容段落，无需去除其中无关的表格数据内容，完整提取整个表格数据。",
    "usedReviewFileContent": "对在审查当前指标过程中用到的【待审查文件内容】，需根据【报告查询词列表】和【审查项要求】提取出相关完整的上下文段落内容，无关内容全部去除，严格保留原文段落的**所有格式符号（包括#、标点、缩进、换行符）**，不做任何内容修改，最终以列表形式严格保留原文格式。若使用到表格中的数据，需提取包含表格标题且从 <html> 标签开始到 </html> 标签结束的完整原始表格内容段落，无需去除其中无关的表格数据内容，完整提取整个表格数据。若出现重复段落（文本存在重叠且整体几乎一致），取这些段落内容的交集作为结果保留。严格保持段落在原始文件中的出现顺序，重复内容取交集后仍按首次出现顺序排列"
}
"""
    messages = [
    {
        "role": "system",
        "content": "你是一名专业的水利科学院文档智能合规审查员，具备丰富的水资源论证报告审查经验。你的任务是对给出的参考知识库内容和待审查文件内容进行提取工作，必须严格按照指定的JSON格式输出，禁止添加任何额外内容或格式。请完整输出提取的相关知识库内容和审查文件内容，不要省略，不要添加任何特殊符号。"
    },
    {
    "role": "user",
    "content": f'''以下是进行关键要素提取提供的信息：
    【审查项要求】: {reviewItemPrompt}
    【知识库查询词列表】:{kbSearchConfig}
    【参考知识库内容】:{relArray}
     请按照要求从【参考知识库内容】中提取相关的上下文内容，**严格保留所有原始格式符号（包括#、标点、换行符）和段落结构**，并严格以JSON格式返回审查结果，
     JSON格式如下: {json_format}
     '''
    }
]
    
    try:
        """
        response = await client.chat.completions.create(
            model='deepseek-r1',  # 此处以qwen-plus为例，可按需更换模型名称。模型列表：https://help.aliyun.com/zh/model-studio/getting-started/models
            messages=messages,
            stream=False,
            temperature=0,
            top_p=0.1,
            response_format={"type": "json_object"}
        )
        response = response.choices[0].message.content.replace("```json", "").replace("```", "").strip()
        #print(f'response: {response}')
        """
        response = ""
        completion = await client.chat.completions.create(
                model='deepseek-r1', 
                messages=messages,
                stream=True,
                temperature=0,
                top_p=0.1,
                response_format={"type": "json_object"}
              
        )
                
        async for chunk in completion:
            if not chunk.choices:
                continue

            delta = chunk.choices[0].delta

            # 收到content，开始进行回复
            if hasattr(delta, "content") and delta.content:
                response += delta.content

        # 去除 Markdown 标记
        response = response.replace("```json", "").replace("```", "").strip()
        
              
        # 使用正则表达式替换两个或以上的 \ 加上 n 为 \n
        response = re.sub(r'\\{2,}n', '\n', response)
        result_json = json.loads(response)
        # 为 usedKnowledgeBaseContent 中的每个元素添加 num 字段
        
        for i, item in enumerate(result_json["usedKnowledgeBaseContent"], start=1):
            item["num"] = i
        
        #print(f'result_json:{result_json}')
        #logger.info(f'extract_result_json:{result_json}')
        
        # 写入日志文件
        with open('test.log', 'a', encoding='utf-8') as f:
            json.dump(result_json, f, ensure_ascii=False, indent=2)
            f.write('\n' + '-' * 50 + '\n')  # 添加分隔符便于阅读
        logger.info("审查结果已成功写入test.log")
        #print(type(result_json))
        
        return {'code':200, 'message': '关键要素提取成功','knowledgeBaseResult': [[result_json["usedKnowledgeBaseContent"]]]}
    
    except Exception as e:
        return {'code':500, 'message': f"审查项模型调用失败，错误详情: {str(e)}",'knowledgeBaseResult': relArray}


'''
from fastapi import APIRouter, Body
from openai import AsyncOpenAI
import asyncio
#from config import get_logger

# 初始化 OpenAI 客户端
client = AsyncOpenAI(
    api_key="sk-762b0529add947b081778614c7fe1cda",
    base_url="https://dashscope.aliyuncs.com/compatible-mode/v1"
)

router = APIRouter()
#logger = get_logger(__name__)

@router.post("/llm_extract_key_elements/")
async def llm_extract_key_elements(
    query: str = Body(..., description="需要提取的核心关键词/问题"),
    context: str = Body(..., description="待筛选的完整上下文文本")
):
    """
    基于大模型的智能要素提取接口
    通过自然语言指令实现语义级信息筛选，返回结构化关键段落
    """
    
    # 关键修改：严格限定模型只输出段落原文，不允许任何额外内容
    messages = [
        {
            "role": "user",
            "content": f"""请从以下上下文中提取所有与【{query}】直接相关的段落，要求：
                       1. 严格保留原文段落格式，不做任何修改
                       2. 只输出段落内容，不添加任何解释、序号或标记
                       3. 段落之间用换行分隔，无关内容请全部去除
                       上下文：{context}
                       """
        }
    ]
    
    try:
        # 调用大模型进行处理
        response = await client.chat.completions.create(
            model="qwen-max-latest",
            messages=messages,
            stream=False,
            temperature=0.01
        )
        
        full_content = response.choices[0].message.content
        
        return {
            "code": 200,
            "message": "关键要素提取成功",
            "content": full_content
        }
        
    except Exception as e:
        return {
            "code": 500,
            "message": str(e)
        }
'''

if __name__ == "__main__":
    # 示例查询和上下文
    searchconfig = ['第六条取水许可实行分级审批','珠江水利委员会审核取水许可预申请，审批取水许可申请、发放取水许可证']
    reviewItemPrompt = """
    一、数据提取要求
    从待审文件中提取：
    建设项目审批单位（特别标注国家发改委）
    业主用水需求
    取水水源（明确区分地表/地下水）
    取水地点坐标
    年/日取水量（分开标注地表水和地下水）
    已填写的审批机关
    取水河流/流域/湖泊
    从知识库提取：
    珠江委权限通知
    贵州省分级审批办法（含第六条细则）
    贵州省行政区划表（特别注意县级市）
    二、核心判断逻辑
    权限层级判定
    python
    if 审批单位 == "国家发改委":
        应属珠江委审批
    elif 取水量 &gt;= 珠江委阈值:
        需流域机构审批
    elif 取水量 &gt;= 省水利厅阈值:
        需省水利厅审批
    elif 取水量 &gt;= 市水利局阈值:
        需市水利局审批
    else:
        按行政区划判定:
            省级项目 → 省水利厅
            跨市项目 → 省水利厅
            跨县项目 → 市水利局
            县域项目 → 县水务局
    特别规则处理
    发现"万"单位立即换算（如26万→260000）
    功能区审批权归属实际管理行政区
    边界水域判断规则：
    python
    if any in ["边界河流","跨区取水"]:
        提升一级审批层级
    三、输出规范
    请按此框架回应：
    【结论】通过/不通过
    【依据分析】
    1. 水源类型：地下水/地表水（说明不可混用）
    2. 取水量级：换算后数值 vs 审批阈值
    3. 行政区划：项目所在区划（标注是否边界区域）
    4. 权限冲突点：原审批机关 vs 应属机关
    5. 特殊情形处理：如功能区、县级市等
    四、易错点强化
    请特别注意：
    兴义市等县级市按县域处理
    日/年取水量不可交叉比较
    未明确说明的取水范围默认非跨区
    省级新区审批权归属实际管理市/县
    """
    sample_context = """
    
[[[{'num': 1, 'content': '# 一、地级市及自治州管辖情况  \n\n贵阳市（省会）  \n\n市辖区（6 个）：观山湖区（政府驻地）、南明区、云岩区、花溪区、乌当区、白云区  \n县级市（1 个）：清镇市  \n县（3 个）：开阳县、息烽县、修文县  \n功能区：贵安新区（省直管）、双龙航空港经济区（贵阳直管）  \n\n六盘水市  \n\n市辖区（2 个）：钟山区（政府驻地）、水城区  \n县级市（1 个）：盘州市（省直辖，六盘水市代管）  \n特区（1 个）：六枝特区  \n功能区：六盘水高新技术产业开发区  \n\n遵义市  \n\n市辖区（3 个）：红花岗区、汇川区（政府驻地）、播州区县级市（2 个）：赤水市、仁怀市（省直辖，遵义市代管）县（8 个）：桐梓县、绥阳县、正安县、凤冈县、湄潭县、余庆县、习水县自治县（2 个）：道真仡佬族苗族自治县、务川仡佬族苗族自治县功能区：新蒲新区（遵义市管理）  \n\n安顺市  \n\n市辖区（2 个）：西秀区（政府驻地）、平坝区  \n县（4 个）：普定县、镇宁布依族苗族自治县、关岭布依族苗族自治县、紫云苗族布依族  \n自治县  \n功能区：黄果树旅游区（安顺市管理）  \n\n毕节市  \n\n市辖区（1 个）：七星关区（政府驻地）  \n县级市（1 个）：黔西市（省直辖，毕节市代管）  \n县（6 个）：大方县、金沙县、织金县、纳雍县、赫章县  \n自治县（1 个）：威宁彝族回族苗族自治县  \n功能区：金海湖新区（高新区）  \n\n铜仁市  \n\n市辖区（2 个）：碧江区（政府驻地）、万山区  \n\n县（4 个）：江口县、石阡县、思南县、德江县  \n自治县（4 个）：玉屏侗族自治县、印江土家族苗族自治县、沿河土家族自治县、松桃苗  \n族自治县  \n功能区：大龙经济开发区（铜仁市管理）  \n\n黔西南布依族苗族自治州  \n\n县级市（2 个）：兴义市（州政府驻地）、兴仁市县（6 个）：普安县、晴隆县、贞丰县、望谟县、册亨县、安龙县功能区：义龙新区（兴义市管理）  \n\n黔东南苗族侗族自治州  \n\n县级市（1 个）：凯里市（州政府驻地）  \n县（15 个）：黄平县、施秉县、三穗县、镇远县、岑巩县、天柱县、锦屏县、剑河县、台  \n江县、黎平县、榕江县、从江县、雷山县、麻江县、丹寨县  \n\n黔南布依族苗族自治州  \n\n县级市（2 个）：都匀市（州政府驻地）、福泉市  \n县（9 个）：荔波县、贵定县、瓮安县、独山县、平塘县、罗甸县、长顺县、龙里县、惠  \n水县  \n自治县（1 个）：三都水族自治县  \n功能区：都匀经济开发区（黔南州管理）  \n\n二、省直管功能区及管理机构  \n\n贵安新区  \n\n管理机构：贵安新区管理委员会职责：统筹新区规划建设、产业布局及企业服务。  \n\n贵阳高新技术产业开发区管理机构：贵阳高新区管委会职责：推动大数据、高端制造等产业发展。  ', 'fileName': '贵州省行政区划.docx', 'fileId': 'a4721ef3edb99f9decc3be494b50c9b5', 'score': 0.0041824941855914755, 'filePath': './knowledge_base/贵州省行政区划/贵州省行政区划.docx'}], []], [[{'num': 1, 'content': '经《省人民政府修改部分省政府规章的决定》（贵州省人民政府令第119 号）2010 年12 月 1 日修改  \n\n第一条为加强水资源管理和保护，促进水资源的节约与合理开发利用，根据《中华人民共和国水法》及《取水许可和水资源费征收管理条例》（以下简称《条例》）等法律、法规的规定，结合本省实际，制定本办法。  \n\n第二条在本省行政区域内利用取水工程或者设施直接从江河、湖泊或者地下取用水资源的，适用本办法。  \n\n前款所称取水工程或者设施，是指闸、坝、渠道、人工河道、虹吸管、水泵、水井以及水电站等。  \n\n第三条县级以上人民政府水行政主管部门按照分级管理权限，负责取水许可制度的组织实施和监督管理。  \n\n县级以上人民政府水行政主管部门、财政部门和价格主管部门按照本办法规定和管理权限，负责水资源费的征收、管理和监督。  \n\n第四条节约和保护水资源成绩突出，在水资源科学研究中有突出贡献的单位或者个人，县级以上人民政府应当给予表彰和奖励。  \n\n第五条取用水资源的单位或者个人，应当申领取水许可证，并依法缴纳水资源费。但家庭生活、零星散养、圈养畜禽饮用等月取水量在100 立方米以下的取水以及法律、法规规定不需要申领取水许可证和缴纳水资源费的除外。  \n\n第六条取水许可实行分级审批。  \n\n下列取水由省人民政府水行政主管部门审批：  \n\n（一）在本省行政区域内属于长江流域的乌江、三岔河、六冲河、清水河、芙蓉江、赤水河、清水江、氵舞阳河和珠江流域的黄泥河、北盘江、濛江、都柳江、南盘江、红水河的干流河段取水的；  \n\n（二）在市（州、地）边界河流、湖泊和跨市（州、地）行政区域河流、湖泊取水的；  \n（三）由省审批、核准、备案的建设项目的取水；  \n（四）取用地下水日取水量在5000 立方米以上的。  \n\n下列取水由市（州、地）人民政府（行署）水行政主管部门审批：  \n\n（一）在市（州、地）人民政府（行署）水行政主管部门管理的河道取水的；  \n（二）在县（市、区）边界河流、湖泊和跨县（市、区）行政区域河流、湖泊取水的；  \n（三）由市（州、地）审批、核准、备案的建设项目的取水；  \n（四）取用地下水日取水量在1000 立方米至5000 立方米的。  \n\n其他取水，由取水口所在地的县级人民政府水行政主管部门审批。  \n\n国家规定由流域管理机构审批的取水，从其规定。  \n\n第七条县级以上人民政府水行政主管部门应当按照《条例》规定的条件、程序、期限和本办法规定的分级审批权限实施取水许可。  \n\n第八条申请取水的单位或者个人，应当向具有审批权限的水行政主管部门提出申请。  \n\n取水审批机关应当自受理取水申请之日起45 个工作日内作出决定。决定批准的，核发取水许可证；决定不批准的，作出不予行政许可的书面决定并说明理由。  \n\n第九条对直接从江河、湖泊或者地下取水并需要申领取水许可证的新建、改建、扩建的建设项目，建设项目业主单位应当按照有关规定进行建设项目水资源论证，编制建设项目水资源论证报告书。  \n\n第十条对取用城市规划区地下水的取水申请，取水审批机关应当征求建设行政主管部门的意见。  \n\n在风景名胜区内取水的，按照《风景名胜区条例》和其他有关法律、法规的规定执行。  \n\n第十一条取水申请经审批机关批准后，申请人方可兴建取水工程或者设施。需要办理取水许可的建设项目，未取得取水申请批准文件的，项目主管部门不得审批、核准该建设项目。  \n\n第十二条水资源费由取水审批机关负责征收。  \n\n上级水行政主管部门可以委托下级水行政主管部门代为征收水资源费。  \n\n第十三条水资源费征收标准由省人民政府价格主管部门会同同级财政部门、水行政主管部门制定，报省人民政府批准后执行。若需调整，应当按照原审批程序重新报批。  \n\n第十四条取水单位或者个人应当按照经批准的年度取水计划或者定额取水。  \n\n超计划或者超定额取水的，对超计划或者超定额部分累进收取水资源费。  \n\n年实际取水量超过核准的年取水计划或者定额的，超取部分按照以下标准缴纳水资源费：  \n\n（一）超额 $30\\%$ 以下的，超过部分按照规定标准的2 倍缴纳；  \n（二）超额 $30\\%$ 至 $50\\%$ 的，超过部分按照规定标准的3 倍缴纳；  \n（三）超额 $50\\%$ 以上的，超过部分按照规定标准的5 倍缴纳。  \n\n第十五条按发电量计收水资源费的单位或者个人，不提供实际发电量报表的，按照设计发电功率连续满负荷运转计收水资源费。  \n\n第十六条水资源费可以按月或者按季征收。取水审批机关确定水资源费缴纳数额后，应当向取水单位或者个人送达水资源费缴纳通知单，取水单位或者个人应当自收到缴纳通知单之日起7 日内办理缴纳手续。  \n\n水资源费计入供水成本。  \n\n第十七条征收的水资源费全额纳入财政预算，主要用于水资源的节约、保护和管理，也可以用于水资源的合理开发。  \n\n第十八条县级以上人民政府水行政主管部门、审计部门、财政部门、行政监察部门和价格主管部门，发现实施取水许可或者水资源费征收、使用中的违法违规行为，应当责令限期改正或者依法作出其他处理。  \n\n第十九条县级以上人民政府水行政主管部门应当向上一级水行政主管部门报送本行政区域内上一年度取水许可证核发情况。  \n\n上级水行政主管部门发现越权审批、取水许可证核准的总取水量超过水量分配方案或者水量分配协议规定数量、年度实际取水量超过下达的年度取水分配方案或者取水计划的，应当要求有关水行政主管部门纠正。  \n\n第二十条县级以上人民政府水行政主管部门在进行监督检查时，有权采取下列措施：  \n\n（一）要求被检查单位或者个人提供有关文件、证照、资料；  \n（二）要求被检查单位或者个人就执行《条例》和本办法的有关问题作出说明；  \n（三）进入被检查单位或者个人的生产场所进行调查；  \n（四）责令被检查单位或者个人停止违反《条例》和本办法的行为，履行法定义务；  \n（五）查阅、复制有关征收水资源费所需的单据、票据、帐薄、记帐凭证和报表等。  \n\n监督检查人员在进行监督检查时，应当出示合法有效的行政执法证件，并不得妨碍有关单位或者个人正常的生产经营活动。  \n\n有关单位或者个人不得拒绝或者阻碍监督检查人员依法执行公务。  \n\n第二十一条县级以上人民政府水行政主管部门或者其他有关部门及其工作人员，违反本办法规定，滥用职权、玩忽职守、徇私舞弊，尚不构成犯罪的，依法给予行政处分。  \n\n第二十二条本办法自 2007 年 4 月 1 日起施行。1992 年 8 月 17 日贵州省人民政府发布的《贵州省水资源费征收管理办法》（黔府发〔1992〕55 号）同时废止。  ', 'fileName': '贵州省取水许可和水资源费征收管理办法.docx', 'fileId': '358b80821985ae1f4174c7ecb7314e4f', 'score': 0.9967141667081211, 'filePath': './knowledge_base/水行政管理/贵州省取水许可和水资源费征收管理办法.docx'}, {'num': 2, 'content': '# 关于授予珠江水利委员会取水许可管理权  \n\n# 限的通知  \n\n云南、贵州、广西、广东、海南、福建省（自治区）人民政府办公厅、水利（水电）厅（局），珠江水利委员会：  \n\n为加强珠江流域（片）水资源的统一管理，促进水资源的合理开发利用、保护和节约用水、计划用水，根据《中华人民共和国水法》和国务院颁发的《取水许可制度实施办法》以及经国务院批准的《珠江流域综合利用规划》等法规、文件，在征求和协调流域（片）内各省、自治区水行政主管部门意见的基础上，经研究决定，我部授予珠江水利委员会在珠江流域（片）实施取水许可管理的权限如下：  \n\n一、根据国务院1994 年1 月批准的水利部“三定”方案，珠江水利委员会为我部的派出机构，国家授权其在珠江流域（片）内行使水行政主管部门职责，负责我部授权范围内取水许可制度的组织实施和监督管理。  \n\n二、下列河道管理范围内限额以上的取水，由珠江水利委员会审核取水许可预申请，审批取水许可申请、发放取水许可证：  \n\n# （一）西江干流  \n\n1.桂平至思贤滘西滘口：地表水日取水量43 万立方米以上的工业与城镇生活取水；或设计流量10 立方米每秒以上的农业取水。  \n\n2.思贤滘西滘口（含）以下西江干流及其出海水道（含西海水道、磨刀门水道）：地表水日取水量 30 万立方米以上的工业与城镇生活取水；或设计流量 10 立方米每秒以上（电灌）和30 立方米每秒以上（潮灌）的农业取水。  \n\n# （二）北江干流  \n\n思贤滘北滘口（含）以下北江干流及其出海水道（含顺德水道、沙湾水道）：地表水日取水量 26 万立方米以上的工业与城镇生活取水；或设计流量 10 立方米每秒以上（电灌）和30 立方米每秒以上（潮灌）的农业取水。  \n\n# （三）南盘江、红水河  \n\n南盘江黄泥河口至红水河曹渡河口：地表水日取水量 26 万立方米以上的工业及城镇生活取水或设计流量6 立方米每秒以上的农业取水。三、东江、韩江、北盘江、都柳江、贺江、涟江等跨省（自治区）河流以及北江思贤滘以上干流河段，根据现实情况由有关省、自治区水行政主管部门，依照分级管理权限实施取水许可管理；珠江水利委员会可视今后水资源开发利用情况，需要时，再确定指定河段及  \n\n限额，报部批准后实施。  \n\n四、珠江流域（片）内由国务院批准的大型建设项目的取水（包括取地下水），以及跨省、自治区行政区域的取水，由珠江水利委员会实行全额管理，受理、审核取水许可预申请，受理、审批取水许可申请、发放取水许可证。五、上述第二条中所列河流指定河段限额以下的取水以及其它河流（河段）的取水，由地方水行政主管部门依照分级管理的权限实施取水许可管理。珠江水利委员会对取水总量实行监督管理：1.凡依照分级管理原则，由流域（片）内各省（自治区）水行政主管部门审批的取水项目，需报珠江水利委员会核备；2.每年年终，由各省（自治区）水行政主管部门汇总取水情况，向珠江水利委员会报送年度取水总结和下一年度用水计划。六、在本通知下达前，凡已在我部授权珠江水利委员会实施取水许可管理范围内取水的单位和个人，应当依照我部《取水许可申请审批程序规定》，在 1995 年4 月1 日前，到珠江水利委员会办理取水登记，领取取水许可证，其中已在当地水行政主管部门登记、领证的，应到珠江水利委员会办理换领取水许可证等手续。七、珠江水利委员会应依照《取水许可制度实施办法》和《取水许可申请审批程序规定》，在我部授权范围内，结合本流域（片）实际情况，制定《取水许可制度实施办法》珠江流域（片）实施细则。珠江水利委员会要切实做好我部授权范围内的取水许可管理工作，与各地密切配合，认真贯彻《取水许可制度实施办法》，全面推进珠江流域（片）的取水许可管理工作，使有限的水资源更好地为珠江流域（片）的社会和经济发展服务。  ', 'fileName': '关于授予珠江水利委员会取水许可管理权限的通知.docx', 'fileId': '44b2aa5b678cabf4a9124cd6ea6dd843', 'score': 0.438454558304217, 'filePath': './knowledge_base/水行政管理/关于授予珠江水利委员会取水许可管理权限的通知.docx'}], []]]
"""

    async def test():
        result = await llm_extract_key_elements(searchconfig,reviewItemPrompt,sample_context)
        #print(result)

    asyncio.run(test())
